# Specify the version of the docker-compose file format
version: "3.9"

# Define the services that make up your application
services:
  db:
    # Use the postgres:15 image from Docker Hub
    image: postgres:15.3

    # Restart the container unless it is stopped by the user
    restart: unless-stopped

    # Expose port 5432 on the host and map it to port 5432 on the container
    ports:
      - "5432:5432"

    # Set environment variables for the database configuration
    environment:
      POSTGRES_DB: dauth
      POSTGRES_USER: dauth
      POSTGRES_PASSWORD: dauth

    # Mount a named volume to persist the database data
    volumes:
      - postgresql-data:/var/lib/postgresql/data

    # Assign the db service to the backend network
    networks:
      app-network:
        aliases:
          - backend

  backend:
    container_name: backend_container

    # Use the backend image that is built from the Dockerfile in the current directory
    build: .

    depends_on:
      - db

    # Expose port 8000 on the host and map it to port 8000 on the container for the web server
    # Expose port 5678 on the host and map it to port 5678 on the container for the debugger
    ports:
      - "8000:8000"

    environment:
      - POETRY_VIRTUALENVS_CREATE=false

    env_file:
      - ./.envs/.env.dev

    # Mount a named volume to persist the backend django project
    volumes:
      - static_data:/backend/src/static
      # - .:/backend

    networks:
      app-network:
        aliases:
          - backend

  nginx:
    build:
      context: ./nginx
      dockerfile: ./Dockerfile

    volumes:
      - static_data:/backend/src/static
      - nginx-data:/etc/nginx

    ports:
      - "8080:8080"

    depends_on:
      - backend

    networks:
      app-network:
        aliases:
          - nginx

volumes:
  postgresql-data:
  static_data:
  nginx-data:

networks:
  app-network:
    driver: bridge
